# Makefile ルール
 
### ローカルで粗い＋細かい
`make run`

### ローカルで細かさ 50
`make run-detail N=50`

### 生成した画像イメージをまとめて削除
`make clean`

~~# Docker イメージ作成~~
~~make docker-build~~

~~# Dockerで粗い＋細かい~~
~~make docker-run~~

~~# Dockerで細かさ 80~~

~~make docker-run-detail N=80~~

## ロジック

今回のプログラムでは、「入力画像の形に沿って迷路を自動生成する」という仕組みを実装しています。処理の流れとしては大きく5段階に分かれており、画像の読み込みから迷路の描画までを順番に行います。

1. 迷路の元になる画像の読み込み。
画像は一度グレースケールに変換 -> 明るさの閾値を使って白と黒の2値に分けます。
この段階で、画像のどの部分を「迷路として使える領域」とみなすかを決めるためのマスクを作っています。
白い部分を通路候補、黒い部分を壁扱いとするイメージです。

2. このマスク画像を迷路の“セル単位”に縮小します。
迷路の粗さ・細かさはこのセル数で決まるため、セル数を増やせば細かい迷路に、減らせば大きめの通路を持つ迷路になります。ここで、迷路に使ってよいセル（画像中で白だった領域）と使ってはいけないセルを仕分けします。

3. 迷路そのものの構造は「深さ優先探索」で作っています。
まだ通っていないセルをランダムに選んで進み、分岐があれば迷わず奥に突き進む方式で、行き止まりにぶつかったら来た道を戻り、別の方向を掘っていきます。

4. 移動するたびに「セルとセルの間の壁を削る」ことで通路がつながり、結果として自然な迷路らしい形状が出来上がります。

5. このセル迷路を画像として描き起こします。セルを白い通路、セルの周囲を黒い壁として並べていき、必要に応じて拡大して見やすくしてから PNG として書き出しています。

### 作ってみて

今回の迷路生成では、通路にランダム性がほしかったので 穴掘り法（DFS） を使って作りました。最初は全部が壁で、その中をランダムに掘っていくタイプのアルゴリズムです。毎回違う迷路ができるので、試していて楽しかったです。

画像処理の部分は、AI に強い友達に相談しながら OpenCV を使って実装しました。元画像を 2 値化して「ここは通路にして OK」「ここは壁」といった感じでマスクを作っています。42の課題で Mandelbrot 集合を X Window System で描画する課題があったのですが、そのとき画像処理が面白いなと思っていて、今回の制作でもその経験が役に立ちました。

あと、Windows でも動かせるように Docker にも挑戦しました。ただ、環境の細かい設定が間に合わず、完全に動くところまではいきませんでした。次はちゃんと最後まで仕上げたいです。

デバッグ用には、真っ黒画像（掘り進める場所がないやつ）とか、白い点がちょっとだけある画像みたいな極端なパターンも用意して試しました。本当は、こういう「DFS がスタートできないケース」でエラーを返す処理も入れたかったのですが、今回は時間的にそこまで手が回りませんでした。

でも、画像をマスク化して、セルに縮めて、そこから迷路を掘って画像として描き出すという流れを全部自分で組めたのは、かなり良い経験になりました。画像処理とアルゴリズムの組み合わせが思ったより楽しくて、また何か作りたいなと思っています。